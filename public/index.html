<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lamina - Composite Design Tool</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Lamina</h1>
        <p>Composite Laminate Design & Analysis</p>

        <div class="panel">
            <h2>Material Properties</h2>
            <div class="input-grid">
                <label title="Longitudinal Young's Modulus">E1 (Pa): <input type="number" id="E1" value="140e9"></label>
                <label title="Transverse Young's Modulus">E2 (Pa): <input type="number" id="E2" value="10e9"></label>
                <label title="In-plane Shear Modulus">G12 (Pa): <input type="number" id="G12" value="5e9"></label>
                <label title="Major Poisson's Ratio">v12: <input type="number" id="v12" value="0.3"></label>
                <label title="Longitudinal Tensile Strength">Xt (Pa): <input type="number" id="Xt" value="1500e6"></label>
                <label title="Longitudinal Compressive Strength">Xc (Pa): <input type="number" id="Xc" value="1200e6"></label>
                <label title="Transverse Tensile Strength">Yt (Pa): <input type="number" id="Yt" value="50e6"></label>
                <label title="Transverse Compressive Strength">Yc (Pa): <input type="number" id="Yc" value="250e6"></label>
                <label title="In-plane Shear Strength">S (Pa): <input type="number" id="S" value="70e6"></label>
            </div>
        </div>

        <div class="panel">
            <h2>Laminate Definition</h2>
            <div class="input-row">
                <label>Stacking Sequence (deg): <input type="text" id="stack" value="0, 45, -45, 90"></label>
                <label>Symmetry: <input type="checkbox" id="symmetry" checked></label>
                <label>Ply Thickness (m): <input type="number" id="thickness" value="0.000125"></label>
            </div>
            <button onclick="calculate(this)">Calculate Properties</button>
            <button onclick="plotPolar(this)">Plot Stiffness Polar</button>
            <button onclick="plotEnvelope(this)">Plot Failure Envelope</button>
        </div>

        <div class="results">
            <div class="panel" id="properties-panel">
                <h3>Engineering Constants</h3>
                <div id="constants-output"></div>
                <h3>ABD Matrix</h3>
                <pre id="abd-output"></pre>
            </div>

            <div class="panel">
                <h3>Stiffness Polar Plot (Ex)</h3>
                <div id="polar-plot"></div>
            </div>

            <div class="panel">
                <h3>Failure Envelope (Tsai-Wu)</h3>
                <div id="envelope-plot"></div>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>
    <script src="polar_plot.js"></script>
    <script src="failure_envelope.js"></script>
    <script>
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.role = type === 'error' ? 'alert' : 'status';
            toast.textContent = message;

            container.appendChild(toast);

            // Remove after 5 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        function setLoading(btn, isLoading) {
            if (isLoading) {
                btn.setAttribute('disabled', 'true');
                btn.setAttribute('aria-busy', 'true');
                btn.dataset.originalText = btn.innerText;
                btn.innerHTML = '<span class="spinner"></span> Processing...';
            } else {
                btn.removeAttribute('disabled');
                btn.setAttribute('aria-busy', 'false');
                btn.innerText = btn.dataset.originalText;
            }
        }

        async function getLaminateData() {
            const E1 = parseFloat(document.getElementById('E1').value);
            const E2 = parseFloat(document.getElementById('E2').value);
            const G12 = parseFloat(document.getElementById('G12').value);
            const v12 = parseFloat(document.getElementById('v12').value);

            const stackStr = document.getElementById('stack').value;
            const stack = stackStr.split(',').map(s => parseFloat(s.trim()));
            const symmetry = document.getElementById('symmetry').checked;
            const thickness = parseFloat(document.getElementById('thickness').value);

            return {
                material: { E1, E2, G12, v12 },
                stack,
                symmetry,
                thickness
            };
        }

        async function getLimits() {
             return {
                xt: parseFloat(document.getElementById('Xt').value),
                xc: parseFloat(document.getElementById('Xc').value),
                yt: parseFloat(document.getElementById('Yt').value),
                yc: parseFloat(document.getElementById('Yc').value),
                s: parseFloat(document.getElementById('S').value)
             };
        }

        async function handleApiError(response) {
            const errData = await response.json().catch(() => ({}));
            let msg = 'Server error';
            if (errData.detail) {
                if (Array.isArray(errData.detail)) {
                    msg = errData.detail.map(e => {
                        const field = e.loc ? e.loc[e.loc.length - 1] : 'Error';
                        return `${field}: ${e.msg.replace('Value error, ', '')}`;
                    }).join('\n');
                } else {
                    msg = errData.detail;
                }
            }
            throw new Error(msg);
        }

        function formatEngineeringConstants(props) {
            const items = [
                { label: 'Ex', value: props.Ex, unit: 'Pa', convert: v => (v/1e9).toFixed(2) + ' GPa', title: "Longitudinal Modulus" },
                { label: 'Ey', value: props.Ey, unit: 'Pa', convert: v => (v/1e9).toFixed(2) + ' GPa', title: "Transverse Modulus" },
                { label: 'Gxy', value: props.Gxy, unit: 'Pa', convert: v => (v/1e9).toFixed(2) + ' GPa', title: "Shear Modulus" },
                { label: 'vxy', value: props.vxy, unit: '', convert: v => v.toFixed(3), title: "Poisson's Ratio" }
            ];

            return `
                <div class="input-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                    ${items.map(item => `
                        <div class="result-item" title="${item.title}">
                            <strong>${item.label}:</strong> ${item.convert(item.value)}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function formatMatrix(matrix) {
            // matrix is 6x6 array (list of lists)
            return matrix.map(row =>
                row.map(val => val.toExponential(2).padStart(11)).join('  ')
            ).join('\n');
        }

        async function calculate(btn) {
            setLoading(btn, true);
            try {
                const data = await getLaminateData();
                const response = await fetch('/api/calculate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    await handleApiError(response);
                }

                const result = await response.json();

                document.getElementById('constants-output').innerHTML = formatEngineeringConstants(result.properties);
                document.getElementById('abd-output').textContent = formatMatrix(result.ABD);
                showToast('Calculation complete', 'success');
            } catch (error) {
                console.error('Error:', error);
                showToast(error.message, 'error');
            } finally {
                setLoading(btn, false);
            }
        }

        async function plotPolar(btn) {
            setLoading(btn, true);
            try {
                const data = await getLaminateData();
                const response = await fetch('/api/polar', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    await handleApiError(response);
                }

                const result = await response.json();
                drawPolar(result);
                showToast('Stiffness polar plotted', 'success');
            } catch (error) {
                console.error('Error:', error);
                showToast(error.message, 'error');
            } finally {
                setLoading(btn, false);
            }
        }

        async function plotEnvelope(btn) {
            setLoading(btn, true);
            try {
                const lamData = await getLaminateData();
                const limits = await getLimits();
                const response = await fetch('/api/failure', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({laminate: lamData, limits})
                });

                if (!response.ok) {
                    await handleApiError(response);
                }

                const result = await response.json();
                drawEnvelope(result);
                showToast('Failure envelope plotted', 'success');
            } catch (error) {
                console.error('Error:', error);
                showToast(error.message, 'error');
            } finally {
                setLoading(btn, false);
            }
        }
    </script>
</body>
</html>
