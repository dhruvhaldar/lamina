<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lamina - Composite Design Tool</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Lamina</h1>
        <p>Composite Laminate Design & Analysis</p>

        <div class="panel">
            <h2>Material Properties</h2>
            <div class="input-grid">
                <label title="Longitudinal Young's Modulus">E1 (Pa): <input type="number" id="E1" value="140e9"></label>
                <label title="Transverse Young's Modulus">E2 (Pa): <input type="number" id="E2" value="10e9"></label>
                <label title="In-plane Shear Modulus">G12 (Pa): <input type="number" id="G12" value="5e9"></label>
                <label title="Major Poisson's Ratio">v12: <input type="number" id="v12" value="0.3"></label>
                <label title="Longitudinal Tensile Strength">Xt (Pa): <input type="number" id="Xt" value="1500e6"></label>
                <label title="Longitudinal Compressive Strength">Xc (Pa): <input type="number" id="Xc" value="1200e6"></label>
                <label title="Transverse Tensile Strength">Yt (Pa): <input type="number" id="Yt" value="50e6"></label>
                <label title="Transverse Compressive Strength">Yc (Pa): <input type="number" id="Yc" value="250e6"></label>
                <label title="In-plane Shear Strength">S (Pa): <input type="number" id="S" value="70e6"></label>
            </div>
        </div>

        <div class="panel">
            <h2>Laminate Definition</h2>
            <div class="input-row">
                <label>
                    Stacking Sequence (deg):
                    <input type="text" id="stack" value="0, 45, -45, 90" aria-describedby="stack-helper">
                    <span id="stack-helper" class="helper-text">Format: 0, 45, -45, 90</span>
                </label>
                <label>Symmetry: <input type="checkbox" id="symmetry" checked></label>
                <label>Ply Thickness (m): <input type="number" id="thickness" value="0.000125"></label>
            </div>
            <button onclick="calculate(this)">Calculate Properties</button>
            <button onclick="plotPolar(this)">Plot Stiffness Polar</button>
            <button onclick="plotEnvelope(this)">Plot Failure Envelope</button>
        </div>

        <div class="results">
            <div class="panel" id="properties-panel">
                <h3>Engineering Constants</h3>
                <div id="constants-output" class="empty-state">Run calculation to view engineering constants.</div>
                <h3>ABD Matrix</h3>
                <div id="abd-output" class="empty-state">Run calculation to view ABD matrix.</div>
            </div>

            <div class="panel">
                <h3>Stiffness Polar Plot (Ex)</h3>
                <div id="polar-plot" class="empty-state">Plot stiffness to visualize anisotropy.</div>
            </div>

            <div class="panel">
                <h3>Failure Envelope (Tsai-Wu)</h3>
                <div id="envelope-plot" class="empty-state">Plot envelope to visualize failure limits.</div>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>
    <script src="polar_plot.js"></script>
    <script src="failure_envelope.js"></script>
    <script>
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.role = type === 'error' ? 'alert' : 'status';
            toast.textContent = message;

            container.appendChild(toast);

            // Remove after 5 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        function setLoading(btn, isLoading) {
            if (isLoading) {
                btn.setAttribute('disabled', 'true');
                btn.setAttribute('aria-busy', 'true');
                btn.dataset.originalText = btn.innerText;
                btn.innerHTML = '<span class="spinner"></span> Processing...';
            } else {
                btn.removeAttribute('disabled');
                btn.setAttribute('aria-busy', 'false');
                btn.innerText = btn.dataset.originalText;
            }
        }

        async function getLaminateData() {
            const E1 = parseFloat(document.getElementById('E1').value);
            const E2 = parseFloat(document.getElementById('E2').value);
            const G12 = parseFloat(document.getElementById('G12').value);
            const v12 = parseFloat(document.getElementById('v12').value);

            const stackStr = document.getElementById('stack').value;
            const stack = stackStr.split(',').map(s => parseFloat(s.trim()));
            const symmetry = document.getElementById('symmetry').checked;
            const thickness = parseFloat(document.getElementById('thickness').value);

            return {
                material: { E1, E2, G12, v12 },
                stack,
                symmetry,
                thickness
            };
        }

        async function getLimits() {
             return {
                xt: parseFloat(document.getElementById('Xt').value),
                xc: parseFloat(document.getElementById('Xc').value),
                yt: parseFloat(document.getElementById('Yt').value),
                yc: parseFloat(document.getElementById('Yc').value),
                s: parseFloat(document.getElementById('S').value)
             };
        }

        async function handleApiError(response) {
            const errData = await response.json().catch(() => ({}));
            let msg = 'Server error';
            if (errData.detail) {
                if (Array.isArray(errData.detail)) {
                    msg = errData.detail.map(e => {
                        const field = e.loc ? e.loc[e.loc.length - 1] : 'Error';
                        return `${field}: ${e.msg.replace('Value error, ', '')}`;
                    }).join('\n');
                } else {
                    msg = errData.detail;
                }
            }
            throw new Error(msg);
        }

        function formatEngineeringConstants(props) {
            const items = [
                { label: 'Ex', value: props.Ex, unit: 'Pa', convert: v => (v/1e9).toFixed(2) + ' GPa', title: "Longitudinal Modulus" },
                { label: 'Ey', value: props.Ey, unit: 'Pa', convert: v => (v/1e9).toFixed(2) + ' GPa', title: "Transverse Modulus" },
                { label: 'Gxy', value: props.Gxy, unit: 'Pa', convert: v => (v/1e9).toFixed(2) + ' GPa', title: "Shear Modulus" },
                { label: 'vxy', value: props.vxy, unit: '', convert: v => v.toFixed(3), title: "Poisson's Ratio" }
            ];

            return `
                <div class="input-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                    ${items.map(item => `
                        <div class="result-item" title="${item.title}">
                            <strong>${item.label}:</strong> ${item.convert(item.value)}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function formatMatrix(matrix) {
            // matrix is 6x6 array (list of lists)
            return matrix.map(row =>
                row.map(val => val.toExponential(2).padStart(11)).join('  ')
            ).join('\n');
        }

        async function copyToClipboard(btn) {
            const container = btn.closest('.result-container');
            const text = container.querySelector('pre').innerText;
            try {
                await navigator.clipboard.writeText(text);
                const originalContent = btn.innerHTML;

                // Visual feedback
                btn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    Copied!
                `;
                btn.style.color = '#27ae60';
                btn.style.borderColor = '#27ae60';

                setTimeout(() => {
                    btn.innerHTML = originalContent;
                    btn.style.color = '';
                    btn.style.borderColor = '';
                }, 2000);
            } catch (err) {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy to clipboard', 'error');
            }
        }

        async function calculate(btn) {
            setLoading(btn, true);
            try {
                const data = await getLaminateData();
                const response = await fetch('/api/calculate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    await handleApiError(response);
                }

                const result = await response.json();

                const constsOut = document.getElementById('constants-output');
                constsOut.innerHTML = formatEngineeringConstants(result.properties);
                constsOut.classList.remove('empty-state');

                const abdOut = document.getElementById('abd-output');
                abdOut.innerHTML = `
                    <div class="result-container">
                        <button class="copy-btn" onclick="copyToClipboard(this)" aria-label="Copy ABD Matrix">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M7.5 3.375c0-1.036.84-1.875 1.875-1.875h.375a3.75 3.75 0 013.75 3.75v1.875C13.5 8.161 14.34 9 15.375 9h1.875A3.75 3.75 0 0121 12.75v3.375C21 17.16 20.16 18 19.125 18h-9.75A1.875 1.875 0 017.5 16.125V3.375z" />
                                <path d="M15 5.25a5.23 5.23 0 00-1.279-3.434 9.768 9.768 0 016.963 6.963A5.23 5.23 0 0017.25 5.25h-2.25z" />
                                <path d="M4.5 4.5a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 004.5 22.5h11.25a2.25 2.25 0 002.25-2.25V19.5h-9.375A3.375 3.375 0 015.25 16.125V4.5h-.75z" />
                            </svg>
                            Copy
                        </button>
                        <pre>${formatMatrix(result.ABD)}</pre>
                    </div>
                `;
                abdOut.classList.remove('empty-state');
                showToast('Calculation complete', 'success');
            } catch (error) {
                console.error('Error:', error);
                showToast(error.message, 'error');
            } finally {
                setLoading(btn, false);
            }
        }

        async function plotPolar(btn) {
            setLoading(btn, true);
            try {
                const data = await getLaminateData();
                const response = await fetch('/api/polar', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    await handleApiError(response);
                }

                const result = await response.json();
                document.getElementById('polar-plot').classList.remove('empty-state');
                drawPolar(result);
                showToast('Stiffness polar plotted', 'success');
            } catch (error) {
                console.error('Error:', error);
                showToast(error.message, 'error');
            } finally {
                setLoading(btn, false);
            }
        }

        async function plotEnvelope(btn) {
            setLoading(btn, true);
            try {
                const lamData = await getLaminateData();
                const limits = await getLimits();
                const response = await fetch('/api/failure', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({laminate: lamData, limits})
                });

                if (!response.ok) {
                    await handleApiError(response);
                }

                const result = await response.json();
                document.getElementById('envelope-plot').classList.remove('empty-state');
                drawEnvelope(result);
                showToast('Failure envelope plotted', 'success');
            } catch (error) {
                console.error('Error:', error);
                showToast(error.message, 'error');
            } finally {
                setLoading(btn, false);
            }
        }
    </script>
</body>
</html>
